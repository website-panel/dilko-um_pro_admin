<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğretmen Paneli</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d3d6e; --primary-light: #1a5a96; --primary-lighter: #e7f0f7;
            --success-color: #28a745; --success-dark: #1e7e34; --success-lighter: #eaf6ec;
            --danger-color: #d9534f; --danger-dark: #c9302c; --danger-lighter: #fdeded;
            --warning-color: #f0ad4e; --warning-dark: #ec971f; --warning-lighter: #fff8eb;
            --info-color: #5bc0de; --info-dark: #31b0d5;
            --background-color: #f4f7fa; --card-background: #ffffff;
            --text-color: #333; --text-light: #555;
            --border-color: #e0e0e0; --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color); color: var(--text-color);
            line-height: 1.6; padding-bottom: 50px;
            -webkit-tap-highlight-color: transparent;
        }
        .top-header {
            background-color: var(--primary-color); color: white;
            padding: 20px 15px; box-shadow: var(--shadow);
            text-align: center;
        }
        .top-header h1 { font-size: 1.6em; margin: 0; font-weight: 600; }
        .container {
            width: 100%; max-width: 1100px; /* Genişletildi */
            margin: 20px auto; padding: 0 15px;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 12px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            padding: 25px; margin-bottom: 30px; /* Kartlar arası boşluk arttı */
        }
        .card h2 {
            font-size: 1.4em; /* Biraz büyüdü */
            font-weight: 600; color: var(--primary-color);
            padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
            margin: -25px -25px 25px -25px; /* Alt boşluk arttı */
            padding: 15px 25px;
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            background-color: #f9faff;
        }
        .form-group { display: flex; flex-direction: column; margin-bottom: 20px; }
        .form-group label { font-weight: 600; color: var(--text-light); margin-bottom: 8px; font-size: 0.95em; }
        .zamanlama-grup { display: flex; gap: 15px; align-items: center; }
        .zamanlama-grup .form-group { flex: 1; margin-bottom: 0; }
        .form-group select,
        .form-group input[type="text"], .form-group input[type="number"],
        .form-group input[type="date"], .form-group input[type="time"] {
            width: 100%; padding: 14px 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1em; font-family: 'Poppins', sans-serif;
            background-color: #fff; -webkit-appearance: none; appearance: none;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(26, 90, 150, 0.1);
        }
        .assign-button {
            background-color: var(--success-color); color: white; border: none;
            border-radius: 8px; padding: 15px 25px; font-size: 1.1em; font-weight: 600;
            cursor: pointer; transition: background-color 0.2s; margin-top: 10px;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .assign-button:hover { background-color: var(--success-dark); }
        .assign-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .message { padding: 12px 18px; border-radius: 8px; margin-top: 20px; font-size: 0.95em; display: none; border: 1px solid transparent; }
        .message.success { background-color: var(--success-lighter); color: var(--success-dark); border-color: var(--success-color); }
        .message.error { background-color: var(--danger-lighter); color: var(--danger-dark); border-color: var(--danger-color); }
        .loading-indicator { font-size: 0.9em; color: var(--text-light); display: none; margin-left: 10px; }
        
        #ogrenci-listesi-konteyner { /* Ödev atama formu için */
            max-height: 30vh; overflow-y: auto; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 10px; margin-top: 5px; background-color: #fff;
            -webkit-overflow-scrolling: touch;
        }
        #ogrenci-listesi-konteyner label {
            display: flex; align-items: center; padding: 12px 15px; cursor: pointer;
            border-radius: 6px; margin-bottom: 5px; transition: background-color 0.1s;
        }
        #ogrenci-listesi-konteyner label:hover { background-color: #f0f0f0; }
        #ogrenci-listesi-konteyner input[type="radio"] { margin-right: 12px; width: 18px; height: 18px; }
        #ogrenci-listesi-konteyner label.selected { background-color: var(--primary-light); color: white; font-weight: 500; }

        /* --- YENİ BÖLÜM: Ödev Görüntüleme --- */
        .goruntuleme-alani { display: flex; gap: 25px; }
        .ogrenci-listesi-panel { flex: 0 0 300px; /* Sabit genişlik */ }
        .ogrenci-odevleri-panel { flex: 1; min-width: 0; /* İçeriğin taşmasını önle */ }
        
        #goruntuleme-ogrenci-listesi {
            max-height: 65vh; overflow-y: auto; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 10px; background-color: #fff;
            -webkit-overflow-scrolling: touch;
        }
        .ogrenci-list-item {
            display: block; padding: 12px 15px; cursor: pointer; border-radius: 6px;
            margin-bottom: 5px; transition: background-color 0.1s; font-weight: 500;
        }
        .ogrenci-list-item:hover { background-color: var(--primary-lighter); }
        .ogrenci-list-item.selected { background-color: var(--primary-color); color: white; }
        
        #ogrenci-odevleri-icerik { min-height: 100px; /* Yükleniyor yazısı için */ }
        .odev-tablosu-wrapper { overflow-x: auto; /* Mobilde tablo taşarsa kaydır */ }
        .odev-tablosu { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .odev-tablosu th, .odev-tablosu td {
            padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        .odev-tablosu th {
            background-color: #f8f9fa; font-weight: 600; color: var(--text-light);
            font-size: 0.9em; text-transform: uppercase; white-space: nowrap;
        }
        .odev-tablosu td { font-size: 0.95em; }
        .odev-tablosu tr:last-child td { border-bottom: none; }
        .odev-tablosu .actions { text-align: right; white-space: nowrap; }
        .odev-tablosu .actions button {
            background: none; border: none; cursor: pointer; padding: 5px; margin-left: 8px;
            opacity: 0.7; transition: opacity 0.2s, transform 0.2s;
        }
        .odev-tablosu .actions button:hover { opacity: 1; transform: scale(1.1); }
        .odev-tablosu .actions .edit-btn svg { color: var(--primary-light); }
        .odev-tablosu .actions .delete-btn svg { color: var(--danger-color); }
        .odev-tablosu .actions svg { width: 18px; height: 18px; display: block; }
        
        .status-badge {
             padding: 4px 10px; font-size: 0.8em; font-weight: 600;
             border-radius: 15px; white-space: nowrap;
        }
        .status-badge.atanmis { background-color: var(--primary-lighter); color: var(--primary-dark); }
        .status-badge.zamanlanmis { background-color: var(--warning-lighter); color: var(--warning-dark); }
        .status-badge.tamamlandi { background-color: var(--success-lighter); color: var(--success-dark); }
        /* --- YENİ BÖLÜM SONU --- */

        @media (min-width: 600px) {
             .form-grid-layout {
                 display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end;
             }
             .form-group.full-width { grid-column: 1 / -1; }
             .assign-button { width: auto; grid-column: 1 / -1; justify-self: start; margin-top: 20px; }
        }
         @media (max-width: 850px) { /* Tablet ve altı */
             .goruntuleme-alani { flex-direction: column; }
             .ogrenci-listesi-panel { flex: 0 0 auto; /* Yüksekliği içeriğe göre ayarla */ }
             #goruntuleme-ogrenci-listesi { max-height: 25vh; } /* Yüksekliği azalt */
         }
         @media (max-width: 599px) {
             .zamanlama-grup { flex-direction: column; gap: 0; align-items: stretch; }
             .zamanlama-grup .form-group { margin-bottom: 20px; }
             .odev-tablosu th, .odev-tablosu td { padding: 10px 8px; font-size: 0.9em;} /* Mobilde tablo içeriği */
             .status-badge { padding: 3px 8px; font-size: 0.75em; }
         }
        /* --- Modal (Onay Kutusu) Stilleri --- */
         .modal-overlay { 
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0, 0, 0, 0.6); z-index: 1000; 
             display: flex; justify-content: center; align-items: center; 
             opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; 
         }
         .modal-overlay.show { opacity: 1; visibility: visible; }
         .modal-content { 
             background: white; padding: 30px 40px; border-radius: 12px; 
             text-align: center; max-width: 90%; width: 450px; user-select: none; 
         }
         .modal-content h2 { margin-top: 0; color: var(--danger-dark);}
         .modal-content p { font-size: 1.1em; margin: 0 0 20px 0; color: var(--text-light); }
         .modal-buttons { display: flex; gap: 15px; justify-content: center;}
         .modal-buttons button { 
             border: none; padding: 12px 30px; border-radius: 8px; 
             font-size: 1em; font-weight: 500; cursor: pointer; margin-top: 10px; transition: background-color 0.2s;
         }
         .modal-buttons .cancel { background-color: #6c757d; color: white; }
         .modal-buttons .confirm { background-color: var(--danger-color); color: white; }
         .modal-buttons .cancel:hover { background-color: var(--secondary-dark); }
         .modal-buttons .confirm:hover { background-color: var(--danger-dark); }
        /* --- Modal Stilleri Bitiş --- */
    </style>
</head>
<body>

    <header class="top-header">
        <h1>Öğretmen Paneli</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>Yeni Ödev Ata</h2>
            <form id="odev-form">
                <div class="form-grid-layout">
                    <div class="form-group full-width">
                        <label for="ogrenci-secim">Öğrenci Seçin</label>
                         <div id="ogrenci-listesi-konteyner">
                             <p id="ogrenci-loading-form">Öğrenciler yükleniyor...</p>
                         </div>
                    </div>
                    <div class="form-group">
                        <label for="odev-baslik">Ödev Başlığı (Opsiyonel)</label>
                        <input type="text" id="odev-baslik" placeholder="Örn: Haftalık Kelime Testi">
                    </div>
                    <div class="form-group">
                        <label for="kategori-secim">Kategori</label>
                        <select id="kategori-secim" required>
                            <option value="" disabled selected>-- Kategori Seçiniz --</option>
                            <optgroup label="Standart Testler">
                                <option value="grammar">Grammar</option>
                                <option value="vocabulary">Vocabulary</option>
                                <option value="preposition">Preposition</option>
                                <option value="sentence_completion">Sentence Completion</option>
                                <option value="paragraph_completion">Paragraph Completion</option>
                                <option value="situation">Situation</option>
                                <option value="dialogue">Dialogue</option>
                                <option value="translations">Translations</option>
                                <option value="mismatching">Mismatching</option>
                                <option value="paraphrasing">Paraphrasing</option>
                            </optgroup>
                            <optgroup label="Okuma Testleri (Paragraf)">
                                <option value="advanced_reading">Advanced Reading</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group" id="soru-sayisi-grup">
                        <label for="soru-sayisi">Soru Sayısı</label>
                        <input type="number" id="soru-sayisi" min="1" max="100" required pattern="\d*" inputmode="numeric" placeholder="Örn: 25">
                    </div>

                    <div class="form-group full-width">
                         <label>Ödev Ne Zaman Görünsün? (Boş bırakırsanız hemen)</label>
                         <div class="zamanlama-grup">
                              <div class="form-group">
                                   <label for="gorunurluk-tarihi" style="font-size: 0.9em; margin-bottom: 4px;">Tarih</label>
                                   <input type="date" id="gorunurluk-tarihi">
                              </div>
                              <div class="form-group">
                                    <label for="gorunurluk-saati" style="font-size: 0.9em; margin-bottom: 4px;">Saat</label>
                                    <input type="time" id="gorunurluk-saati">
                              </div>
                         </div>
                    </div>
                    <button type="submit" class="assign-button" id="assign-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16"> <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z"/> </svg>
                        Ödevi Ata
                        <span class="loading-indicator" id="assign-loading">Atanıyor...</span>
                    </button>
                 </div>
                 <div class="message" id="form-message"></div>
            </form>
        </div>

        <div class="card">
             <h2>Atanmış Ödevler ve Öğrenci Durumu</h2>
             <div class="goruntuleme-alani">
                 <aside class="ogrenci-listesi-panel">
                     <label>Öğrenci Seçin:</label>
                     <div id="goruntuleme-ogrenci-listesi">
                         <p id="ogrenci-loading-view">Öğrenciler yükleniyor...</p>
                     </div>
                 </aside>
                 <main class="ogrenci-odevleri-panel">
                     <h3 id="secili-ogrenci-adi" style="color: var(--primary-light); margin-bottom: 15px;">Öğrencinin Ödevleri</h3>
                     <div id="ogrenci-odevleri-icerik">
                         <p id="odev-listesi-mesaj">Ödevlerini görmek için lütfen listeden bir öğrenci seçin.</p>
                         <div class="odev-tablosu-wrapper" style="display: none;">
                            <table class="odev-tablosu" id="odev-tablosu-body">
                                <thead>
                                    <tr>
                                        <th>Başlık</th>
                                        <th>Kategori</th>
                                        <th>Durum</th>
                                        <th>Tarih</th>
                                        <th>Sonuç</th>
                                        <th class="actions">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                         </div>
                         <p id="odev-listesi-bos" style="display: none; color: var(--text-light); margin-top: 15px;">Bu öğrenciye atanmış ödev bulunmuyor.</p>
                     </div>
                 </main>
             </div>
        </div>

    </div>

     <div id="onay-popup" class="modal-overlay">
         <div class="modal-content">
             <h2>Emin misiniz?</h2>
             <p id="onay-mesaji">Bu işlem geri alınamaz.</p>
             <div class="modal-buttons">
                 <button id="onay-iptal-btn" class="cancel">İptal</button>
                 <button id="onay-devam-btn" class="confirm">Evet</button>
             </div>
         </div>
     </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        // --- YENİ: Timestamp, updateDoc, deleteDoc eklendi ---
        import { getFirestore, collection, doc, getDocs, addDoc, serverTimestamp, Timestamp, query, orderBy, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAvaEaHtTwcuCDBIggJGd4w_nzJQM5UlmY", authDomain: "teacher-adminpanel.firebaseapp.com", projectId: "teacher-adminpanel", storageBucket: "teacher-adminpanel.appspot.com", messagingSenderId: "901735644134", appId: "1:901735644134:web:a6aa575a0754de1333f427", measurementId: "G-68BWZJYCK9" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const readingKategorileri = ['advanced_reading', 'paragraph_test', 'cloze_test'];
        // --- YENİ: Tarih ve Saat formatlayıcı ---
        const dateTimeFormatter = new Intl.DateTimeFormat('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const dateFormatter = new Intl.DateTimeFormat('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });

        let seciliOgrenciId = null; // Görüntüleme bölümünde seçili olan öğrenci

        document.addEventListener('DOMContentLoaded', () => {
              // --- Form Elementleri ---
              const odevForm = document.getElementById('odev-form');
              const assignButton = document.getElementById('assign-button');
              const formMessageDiv = document.getElementById('form-message');
              const assignLoading = document.getElementById('assign-loading');
              const ogrenciListesiKonteyner = document.getElementById('ogrenci-listesi-konteyner');
              const kategoriSelect = document.getElementById('kategori-secim');
              const soruSayisiGrup = document.getElementById('soru-sayisi-grup');
              const soruSayisiInput = document.getElementById('soru-sayisi');
              const soruSayisiLabel = document.querySelector('#soru-sayisi-grup label[for="soru-sayisi"]');
              const gorunurlukTarihiInput = document.getElementById('gorunurluk-tarihi');
              const gorunurlukSaatiInput = document.getElementById('gorunurluk-saati');
              
              // --- Görüntüleme Elementleri ---
              const goruntulemeOgrenciListesi = document.getElementById('goruntuleme-ogrenci-listesi');
              const seciliOgrenciAdiElement = document.getElementById('secili-ogrenci-adi');
              const odevListesiMesaj = document.getElementById('odev-listesi-mesaj');
              const odevTablosuWrapper = document.querySelector('.odev-tablosu-wrapper');
              const odevTablosuBody = document.getElementById('odev-tablosu-body').querySelector('tbody');
              const odevListesiBos = document.getElementById('odev-listesi-bos');


              // --- Form Başlatma ---
              initAssignForm(odevForm, assignButton, formMessageDiv, assignLoading, ogrenciListesiKonteyner, kategoriSelect, soruSayisiGrup, soruSayisiInput, soruSayisiLabel, gorunurlukTarihiInput, gorunurlukSaatiInput);
              
              // --- Görüntüleme Bölümü Başlatma ---
              initViewAssignments(goruntulemeOgrenciListesi, seciliOgrenciAdiElement, odevListesiMesaj, odevTablosuWrapper, odevTablosuBody, odevListesiBos);
         });

        // ===========================================
        // BÖLÜM 1: YENİ ÖDEV ATAMA FONKSİYONLARI
        // ===========================================
        function initAssignForm(odevForm, assignButton, formMessageDiv, assignLoading, ogrenciListesiKonteyner, kategoriSelect, soruSayisiGrup, soruSayisiInput, soruSayisiLabel, gorunurlukTarihiInput, gorunurlukSaatiInput) {
             if (!odevForm) { console.error("Ödev formu bulunamadı!"); return; }

             // Öğrencileri forma yükle
             ogrencileriYukle(ogrenciListesiKonteyner, 'form'); 

             // Kategori seçimine göre Soru Sayısı/Metin Sayısı label'ını ayarla
             kategoriSelect.addEventListener('change', (e) => handleKategoriChange(e, soruSayisiLabel, soruSayisiInput, soruSayisiGrup));
             kategoriSelect.dispatchEvent(new Event('change')); // İlk yüklemede çalıştır

             // Form gönderildiğinde ödevi ata
             odevForm.addEventListener('submit', (e) => handleOdevSubmit(e, ogrenciListesiKonteyner, kategoriSelect, soruSayisiInput, gorunurlukTarihiInput, gorunurlukSaatiInput, assignButton, assignLoading, formMessageDiv, odevForm));
        }

        async function ogrencileriYukle(container, type = 'form') { // type: 'form' or 'view'
            const loadingElementId = type === 'form' ? 'ogrenci-loading-form' : 'ogrenci-loading-view';
            const loadingP = document.getElementById(loadingElementId);
            if (!container) return; 
            
            if(loadingP) container.innerHTML = loadingP.outerHTML; // Yükleniyor... yazısını göster
            else container.innerHTML = '<p>Öğrenciler yükleniyor...</p>';

            try {
                const kullanicilarRef = collection(db, "kullanicilar");
                 const q = query(kullanicilarRef, orderBy("isim", "asc"));
                const querySnapshot = await getDocs(q);
                container.innerHTML = ''; // Temizle

                if (querySnapshot.empty) {
                     container.innerHTML = '<p>Sistemde kayıtlı öğrenci bulunamadı.</p>';
                } else {
                     querySnapshot.forEach(doc => {
                         const ogrenci = doc.data();
                         const ogrenciId = doc.id;
                         const ogrenciAdi = `${ogrenci.isim || ''} ${ogrenci.soyisim || ''}`.trim() || ogrenci.email || ogrenciId;
                         
                         if(type === 'form') { // Form için radio butonlu label
                              const radioId = `ogrenci-${ogrenciId}`;
                              const label = document.createElement('label');
                              label.htmlFor = radioId;
                              label.textContent = ogrenciAdi;
                              label.dataset.uid = ogrenciId;
                              const radioInput = document.createElement('input');
                              radioInput.type = 'radio'; radioInput.id = radioId;
                              radioInput.name = 'ogrenci-radio'; radioInput.value = ogrenciId;
                              radioInput.dataset.name = ogrenciAdi;
                              radioInput.addEventListener('change', (e) => {
                                   container.querySelectorAll('label.selected').forEach(lbl => lbl.classList.remove('selected'));
                                   if (e.target.checked && e.target.closest('label')) {
                                       e.target.closest('label').classList.add('selected');
                                   }
                              });
                              label.prepend(radioInput);
                              container.appendChild(label);
                         } else { // Görüntüleme için tıklanabilir div
                              const div = document.createElement('div');
                              div.classList.add('ogrenci-list-item');
                              div.textContent = ogrenciAdi;
                              div.dataset.uid = ogrenciId;
                              div.dataset.name = ogrenciAdi; // İsmi sakla
                              div.addEventListener('click', handleOgrenciSecim);
                              container.appendChild(div);
                         }
                     });
                 }
            } catch (error) {
                 console.error(`${type} için öğrenciler yüklenirken hata:`, error);
                 container.innerHTML = `<p style="color: red;">Öğrenciler yüklenirken bir hata oluştu.</p>`;
            } finally {
                 // Yükleniyor yazısını gizle (artık container temizlendiği için gerek yok gibi ama kalsın)
                 const loadingElem = document.getElementById(loadingElementId);
                 if(loadingElem) loadingElem.style.display = 'none';
            }
        }

        function handleKategoriChange(e, soruSayisiLabel, soruSayisiInput, soruSayisiGrup) {
            const secilenKategori = e.target.value;
            if (readingKategorileri.includes(secilenKategori)) {
                soruSayisiLabel.textContent = 'Metin Sayısı (Reading)';
                soruSayisiInput.placeholder = 'Örn: 5';
            } else {
                soruSayisiLabel.textContent = 'Soru Sayısı';
                soruSayisiInput.placeholder = 'Örn: 25';
            }
            soruSayisiGrup.style.display = 'block';
            soruSayisiInput.required = true;
        }

        async function handleOdevSubmit(e, ogrenciListesiKonteyner, kategoriSelect, soruSayisiInput, gorunurlukTarihiInput, gorunurlukSaatiInput, assignButton, assignLoading, formMessageDiv, odevForm) {
            e.preventDefault();
            const selectedOgrenciRadio = ogrenciListesiKonteyner.querySelector('input[name="ogrenci-radio"]:checked');
            const odevBaslikInput = document.getElementById('odev-baslik');
            const kategori = kategoriSelect.value;
            
            if (!selectedOgrenciRadio || !kategori) { return showMessage("Lütfen öğrenci ve kategori seçin.", "error"); }

            const soruSayisi = parseInt(soruSayisiInput.value);
            if (isNaN(soruSayisi) || soruSayisi <= 0) {
                const isReading = readingKategorileri.includes(kategori);
                return showMessage(isReading ? "Geçerli metin sayısı girin." : "Geçerli soru sayısı girin.", "error");
            }

            // Zamanlama Hesaplama
            const tarihValue = gorunurlukTarihiInput.value;
            const saatValue = gorunurlukSaatiInput.value;
            let gorunurlukZamani = serverTimestamp(); // Varsayılan: şimdi
            let durum = "atanmis";
            let isZamanlanmis = false;

            if (tarihValue && saatValue) {
                 try {
                      const secilenTimestamp = new Date(`${tarihValue}T${saatValue}:00`).getTime();
                      if (isNaN(secilenTimestamp)) throw new Error("Invalid Date");
                      if (secilenTimestamp > Date.now()) {
                           gorunurlukZamani = Timestamp.fromDate(new Date(secilenTimestamp));
                           durum = "zamanlanmis"; isZamanlanmis = true;
                           console.log("Ödev zamanlandı:", gorunurlukZamani.toDate());
                      }
                 } catch (err) { return showMessage("Geçersiz tarih/saat.", "error"); }
            }

            const ogrenciId = selectedOgrenciRadio.value;
            const baslik = odevBaslikInput.value.trim() || `${kategoriSelect.options[kategoriSelect.selectedIndex].text} Ödevi`;

             assignButton.disabled = true; assignLoading.style.display = 'inline'; formMessageDiv.style.display = 'none';

             try {
                 const odevData = {
                     baslik: baslik, kategori: kategori, soruSayisi: soruSayisi,
                     atanmaTarihi: serverTimestamp(), gorunurlukTarihi: gorunurlukZamani, durum: durum,
                     ...(readingKategorileri.includes(kategori) && { cozulenMetinler: [] }) 
                 };
                 const gorevlerRef = collection(db, "odevler", ogrenciId, "gorevler");
                 await addDoc(gorevlerRef, odevData);

                 const mesaj = isZamanlanmis ? `Ödev zamanlandı.` : `Ödev atandı.`;
                 showMessage(`${mesaj} (${selectedOgrenciRadio.dataset.name})`, "success");
                 odevForm.reset();
                 kategoriSelect.dispatchEvent(new Event('change'));
                 ogrenciListesiKonteyner.querySelectorAll('label.selected').forEach(lbl => lbl.classList.remove('selected'));
             } catch (error) {
                 console.error("Ödev atama hatası:", error);
                 showMessage("Ödev atanırken bir hata oluştu.", "error");
             } finally {
                 assignButton.disabled = false; assignLoading.style.display = 'none';
             }
        }

        // ===========================================
        // BÖLÜM 2: ÖDEV GÖRÜNTÜLEME FONKSİYONLARI
        // ===========================================
        function initViewAssignments(goruntulemeOgrenciListesi, seciliOgrenciAdiElement, odevListesiMesaj, odevTablosuWrapper, odevTablosuBody, odevListesiBos) {
             if (!goruntulemeOgrenciListesi) { console.error("Öğrenci listesi (görüntüleme) bulunamadı!"); return; }
             // Öğrencileri görüntüleme listesine yükle
             ogrencileriYukle(goruntulemeOgrenciListesi, 'view');
        }

        // Öğrenci listesinden birine tıklandığında çalışır
        function handleOgrenciSecim(e) {
             const selectedDiv = e.currentTarget;
             seciliOgrenciId = selectedDiv.dataset.uid;
             const seciliAd = selectedDiv.dataset.name;

             // Seçili öğrenciyi görsel olarak işaretle
             document.querySelectorAll('#goruntuleme-ogrenci-listesi .ogrenci-list-item').forEach(item => {
                  item.classList.remove('selected');
             });
             selectedDiv.classList.add('selected');

             // Ödevleri yükle
             ogrenciOdevleriniYukle(seciliOgrenciId, seciliAd);
        }

        async function ogrenciOdevleriniYukle(ogrenciId, ogrenciAdi) {
            const seciliOgrenciAdiElement = document.getElementById('secili-ogrenci-adi');
            const odevListesiMesaj = document.getElementById('odev-listesi-mesaj');
            const odevTablosuWrapper = document.querySelector('.odev-tablosu-wrapper');
            const odevTablosuBody = document.getElementById('odev-tablosu-body').querySelector('tbody');
            const odevListesiBos = document.getElementById('odev-listesi-bos');

            if (!ogrenciId || !odevTablosuBody || !seciliOgrenciAdiElement || !odevListesiMesaj || !odevTablosuWrapper || !odevListesiBos) {
                 console.error("Ödev listesi elemanları bulunamadı.");
                 return;
            }

            seciliOgrenciAdiElement.textContent = `${ogrenciAdi} - Ödevleri`;
            odevListesiMesaj.textContent = 'Ödevler yükleniyor...';
            odevListesiMesaj.style.display = 'block';
            odevTablosuWrapper.style.display = 'none';
            odevListesiBos.style.display = 'none';
            odevTablosuBody.innerHTML = ''; // Önceki listeyi temizle

            try {
                const odevlerRef = collection(db, "odevler", ogrenciId, "gorevler");
                const q = query(odevlerRef, orderBy("atanmaTarihi", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                     odevListesiMesaj.style.display = 'none';
                     odevListesiBos.style.display = 'block';
                } else {
                     querySnapshot.forEach(doc => {
                          odevTablosuBody.appendChild(odevSatiriOlustur(doc.id, doc.data()));
                     });
                     odevListesiMesaj.style.display = 'none';
                     odevTablosuWrapper.style.display = 'block';
                     // Yeni yüklenen satırlar için event listenerları ata
                     attachAssignmentActionListeners(ogrenciId); 
                }
            } catch (error) {
                console.error(`Öğrenci (${ogrenciId}) ödevleri yüklenirken hata:`, error);
                odevListesiMesaj.textContent = 'Ödevler yüklenirken bir hata oluştu.';
                odevListesiMesaj.style.color = 'red';
                odevTablosuWrapper.style.display = 'none';
                odevListesiBos.style.display = 'none';
            }
        }

        // Tek bir ödev satırını (<tr>) oluşturan fonksiyon
        function odevSatiriOlustur(odevId, odevData) {
            const tr = document.createElement('tr');
            tr.dataset.odevid = odevId; // Satıra ID ekle

            const kategoriAdi = (odevData.kategori || '?').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const baslik = odevData.baslik || 'Başlıksız Ödev';
            
            // Durum Etiketi
            let durumText = '?';
            let durumClass = '';
            let tarihText = '';
            const simdi = new Date();
            const gorunurlukZamani = odevData.gorunurlukTarihi?.toDate();

            if (odevData.durum === 'tamamlandi') {
                 durumText = 'Tamamlandı'; durumClass = 'tamamlandi';
                 tarihText = odevData.tamamlanmaTarihi?.toDate() ? `Tamamlandı: ${dateFormatter.format(odevData.tamamlanmaTarihi.toDate())}` : `Atandı: ${dateFormatter.format(odevData.atanmaTarihi.toDate())}`;
            } else if (odevData.durum === 'zamanlanmis' && gorunurlukZamani > simdi) {
                 durumText = 'Zamanlandı'; durumClass = 'zamanlanmis';
                 tarihText = `Görünür: ${dateTimeFormatter.format(gorunurlukZamani)}`;
            } else { // atanmis veya zamanı gelmiş zamanlanmış
                 durumText = 'Atanmış'; durumClass = 'atanmis';
                 tarihText = `Atandı: ${dateFormatter.format(odevData.atanmaTarihi.toDate())}`;
            }

            // Sonuç
            let sonucText = '-';
            if (odevData.durum === 'tamamlandi' && odevData.sonuc) {
                 let net = parseFloat(odevData.sonuc.netSayisi);
                 sonucText = !isNaN(net) && isFinite(net) ? net.toFixed(2) : '-';
            }

            tr.innerHTML = `
                <td>${baslik}</td>
                <td>${kategoriAdi}</td>
                <td><span class="status-badge ${durumClass}">${durumText}</span></td>
                <td>${tarihText}</td>
                <td>${sonucText}</td>
                <td class="actions">
                    <button class="edit-btn" title="Başlığı Düzenle" data-odevid="${odevId}" data-current-title="${baslik}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/></svg>
                    </button>
                    <button class="delete-btn" title="Ödevi Sil" data-odevid="${odevId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/></svg>
                    </button>
                </td>
            `;
            return tr;
        }

        // Ödev listesindeki Düzenle ve Sil butonlarına listener ekler
        function attachAssignmentActionListeners(studentId) {
             const tableBody = document.getElementById('odev-tablosu-body')?.querySelector('tbody');
             if (!tableBody) return;

             // Sil Butonları
             tableBody.querySelectorAll('.delete-btn').forEach(button => {
                 // CloneNode ile eski listenerları temizle
                 const newButton = button.cloneNode(true);
                 button.parentNode.replaceChild(newButton, button);
                 newButton.addEventListener('click', (e) => {
                     const odevId = e.currentTarget.dataset.odevid;
                     showOnayPopup('Bu ödevi silmek istediğinize emin misiniz?', () => {
                         odeviSil(studentId, odevId); // Öğrenci ID'sini de gönder
                     });
                 });
             });

             // Düzenle Butonları
             tableBody.querySelectorAll('.edit-btn').forEach(button => {
                 const newButton = button.cloneNode(true);
                 button.parentNode.replaceChild(newButton, button);
                 newButton.addEventListener('click', (e) => {
                     const odevId = e.currentTarget.dataset.odevid;
                     const currentTitle = e.currentTarget.dataset.currentTitle;
                     const yeniBaslik = prompt("Yeni ödev başlığını girin:", currentTitle);
                     if (yeniBaslik !== null && yeniBaslik.trim() !== '') {
                          odevBasliginiGuncelle(studentId, odevId, yeniBaslik.trim());
                     } else if (yeniBaslik === '') {
                          alert("Başlık boş olamaz.");
                     }
                 });
             });
        }
        
        // Ödev başlığını güncelleyen fonksiyon
        async function odevBasliginiGuncelle(studentId, odevId, yeniBaslik) {
             if (!studentId || !odevId || !yeniBaslik) return;
             const odevRef = doc(db, "odevler", studentId, "gorevler", odevId);
             try {
                 await updateDoc(odevRef, { baslik: yeniBaslik });
                 console.log(`Ödev (${odevId}) başlığı güncellendi.`);
                 // Listeyi yeniden yükle (veya sadece ilgili satırı güncelle)
                 const studentName = document.querySelector(`#goruntuleme-ogrenci-listesi .ogrenci-list-item[data-uid="${studentId}"]`)?.dataset.name || '';
                 ogrenciOdevleriniYukle(studentId, studentName);
                 showMessage('Ödev başlığı güncellendi.', 'success');
             } catch (error) {
                 console.error("Başlık güncellenirken hata:", error);
                 showMessage('Başlık güncellenirken bir hata oluştu.', 'error');
             }
        }
        
        // Ödevi silme fonksiyonu (öğrenci ID'si eklendi)
        async function odeviSil(studentId, odevId) {
            if (!studentId || !odevId) return alert("Silme hatası: ID eksik.");
            
            const odevRef = doc(db, "odevler", studentId, "gorevler", odevId);
            try {
                await deleteDoc(odevRef);
                console.log(`Öğrenci (${studentId}) Ödevi (${odevId}) silindi.`);
                // Listeyi yeniden yükle
                const studentName = document.querySelector(`#goruntuleme-ogrenci-listesi .ogrenci-list-item[data-uid="${studentId}"]`)?.dataset.name || '';
                ogrenciOdevleriniYukle(studentId, studentName); 
                 showMessage('Ödev başarıyla silindi.', 'success');
            } catch (error) {
                console.error("Ödev silinirken hata:", error);
                showMessage('Ödev silinirken bir hata oluştu.', 'error');
            }
        }

        // --- Yardımcı Fonksiyonlar ---
        function showMessage(message, type = "info") {
            const messageDiv = document.getElementById('form-message'); // Sadece formdaki mesaj alanı hedefleniyor
            if (!messageDiv) { console.warn("Mesaj alanı bulunamadı."); return; }
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                if (messageDiv.textContent === message) { messageDiv.style.display = 'none'; }
            }, 5000);
        }

        function showOnayPopup(mesaj, callback) {
             const popup = document.getElementById('onay-popup');
             if (!popup) return; 
             popup.querySelector('#onay-mesaji').innerHTML = mesaj;
             popup.classList.add('show');
             const iptalBtn = popup.querySelector('#onay-iptal-btn');
             const devamBtn = popup.querySelector('#onay-devam-btn');
             const newDevamBtn = devamBtn.cloneNode(true);
             devamBtn.parentNode.replaceChild(newDevamBtn, devamBtn);
             const newIptalBtn = iptalBtn.cloneNode(true);
             iptalBtn.parentNode.replaceChild(newIptalBtn, iptalBtn);
             const devamListener = () => { popup.classList.remove('show'); callback(); };
             const iptalListener = () => { popup.classList.remove('show'); };
             newDevamBtn.addEventListener('click', devamListener, { once: true });
             newIptalBtn.addEventListener('click', iptalListener, { once: true });
         }

    </script>
</body>
</html>
